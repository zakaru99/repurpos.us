<div class="container-fluid" *ngIf="displayResults" (window:resize)="checkMobile()">

  <!-- ---------------------------
       Results Header (new style)
  ---------------------------- -->
<div id="header-container" class="header-container" style="display: flex; align-items: center; gap: 1rem;">
  <h4 style="margin: 0;">
    {{ dataSource.data.length }} {{ dataSource.data.length === 1 ? "result" : "results" }} found
  </h4>

    <!-- Match filter -->
  <div class="match-filter d-flex align-items-center" style="gap: 0.5rem;">
    <span class="filter-label">Matched in:</span>

    <mat-button-toggle-group
      class="match-toggle"
      appearance="legacy"
      [value]="matchFilter"
      (change)="onMatchFilterChange($event)">
      
      <mat-button-toggle value="all">All</mat-button-toggle>
      <mat-button-toggle value="name">Name</mat-button-toggle>
      <mat-button-toggle value="target">Target</mat-button-toggle>
      <mat-button-toggle value="moa">MOA</mat-button-toggle>
    </mat-button-toggle-group>

  </div>


  <div class="download-options" style="display: flex; align-items: center; gap: 0.5rem;">
    <span>Download Results:</span>
    <button class="dwnld-btn" (click)="dwnldSearch()" aria-label="Download CSV">CSV</button>
    <button class="dwnld-btn" (click)="downloadSDF()" aria-label="Download SDF">SDF</button>
  </div>
</div>

  <!-- ---------------------------
       Table (old style)
  ---------------------------- -->
  <div class="search-result-container mat-elevation-z0" *ngIf="dataSource.data.length > 0">
              <mat-table #table matSort [dataSource]="dataSource" (matSortChange)="onSortChange($event)">

            <!-- Drug name -->
            <ng-container matColumnDef="main_label">
              <mat-header-cell *matHeaderCellDef mat-sort-header disableClear="true" class="mat-header">
                <span class="mat-header">Name</span>
                <mat-icon class='sort-icon' matTooltip="sort by name">sort</mat-icon>
              </mat-header-cell>

              <mat-cell *matCellDef="let element; let row=index" class="main-label d-flex" (click)="expandCell(row)">
                <div class="smscreen-name">
                  <a [routerLink]="['/compound_data', element.id.split('/').pop(), {qid: element.qid.split('/').pop()}]">
                    <h5>{{element['main_label']}}</h5>
                  </a>
                </div>

                <div *ngIf="element['reframeid'] === 'full'" [matTooltip]="rfmTooltip" class="cmpd-avail">
                  Reframe library compound
                </div>
                <div *ngIf="element['reframeid'] === 'stereofree' || element['reframeid'] === 'sub_smiles'" [matTooltip]="rfmTooltip" class="cmpd-avail">
                  Reframe library compound (stereofree)
                </div>

                <table class="table cmpd-info">
                  <tbody>
                    <tr *ngIf="element.aliases.length > 0">
                      <th class="label" scope="row" *ngIf="!isMobile">Aliases:</th>
                      <td class="aliases">
                        <ul class="alias-list">
                          <li *ngFor="let alias of element.aliases | slice:0:element.alias_ct; let i=index">
                            {{alias}}
                            <span *ngIf="i + 1 < element.alias_ct && i + 1 < element.aliases.length" class='data-separator'></span>
                          </li>
                          <li>
                            <a *ngIf="element.alias_ct < element.aliases.length || element.max_aliases" (click)="showMore(row)">
                              {{ element.max_aliases ? 'show fewer' : isMobile ? 'show all aliases' : 'show all' }}
                            </a>
                          </li>
                        </ul>
                      </td>
                    </tr>

                    <tr *ngIf="!isMobile">
                      <th class="label" scope="row">ID:</th>
                      <td class="inchi-id">{{element['id']}}</td>
                    </tr>
                  </tbody>
                </table>

                <mat-icon *ngIf="isMobile" class="more-info" (click)="expandCell(row)">
                  {{element['expanded'] ? 'expand_less': 'expand_more'}}
                </mat-icon>
              </mat-cell>
            </ng-container>

            <!-- Highest Phase -->
            <ng-container matColumnDef="highestPhase">
              <mat-header-cell *matHeaderCellDef mat-sort-header disableClear="true" class="mat-header">
                <span class="mat-header" [matTooltip]="highestTooltip">Highest Phase</span>
                <mat-icon class="sort-icon" matTooltip="sort by highest-phase">sort</mat-icon>
              </mat-header-cell>
              <mat-cell *matCellDef="let element" class="highest-phase-cell">
                <table class="table cmpd-info-table">
                  <tbody>
                    <tr *ngIf="element.highest_phase">
                      <th class="label" scope="row">Highest Phase:</th>
                      <td class="highest-phase">{{ element.highest_phase }}</td>
                    </tr>
                  </tbody>
                </table>
              </mat-cell>
            </ng-container>

            <!-- Similar compounds -->
            <ng-container matColumnDef="similar">
              <mat-header-cell *matHeaderCellDef mat-sort-header disableClear="true" class="mat-header">
                <span class="mat-header" [matTooltip]="similarTooltip">Similar compounds</span>
                <mat-icon class='sort-icon' matTooltip="sort by library compound">sort</mat-icon>
              </mat-header-cell>
              <mat-cell *matCellDef="let element" class="flex-column" [ngClass]="element['expanded'] ? 'expanded' : ''">
                <div class="d-flex justify-content-end flex-grow-1 sim-cmpds">
                  <app-search-result-similar [compound_result]="element" [mobile]="isMobile"></app-search-result-similar>
                </div>
              </mat-cell>
            </ng-container>

            <!-- Tanimoto score -->
            <ng-container matColumnDef="tanimoto">
              <mat-header-cell *matHeaderCellDef mat-sort-header disableClear="true" class="mat-header">
                <span class="mat-header">Tanimoto Similarity Score</span>
                <mat-icon class='sort-icon' matTooltip="sort by Tanimoto score">sort</mat-icon>
              </mat-header-cell>
              <mat-cell *matCellDef="let element" [ngClass]="element['expanded'] ? 'expanded' : ''">
                <div class="d-flex justify-content-center">
                  <div class="tm-icon" [ngStyle]="{'background-color': tanimotoScale(element['tanimoto']), 'color': getFontColor(element['tanimoto'])}">
                    {{element['tanimoto'] | number: '1.2-2'}}
                  </div>
                </div>
              </mat-cell>
            </ng-container>

            <!-- Structure -->
            <ng-container matColumnDef="struct">
              <mat-header-cell *matHeaderCellDef mat-sort-header disableClear="true" class="mat-header">
                <span class="mat-header">Structure</span>
                <mat-icon class='sort-icon' matTooltip="sort by Availability">sort</mat-icon>
              </mat-header-cell>
              <mat-cell *matCellDef="let element" [ngClass]="element['expanded'] ? 'expanded' : ''">
                <table class="structure-table">
                  <tr *ngIf="!isMobile">
                    <td>
                      <div id="available">
                        <span class="label">Availability: </span>
                        <ng-container *ngIf="element.reframeid === 'plated' || element.reframeid === 'one_off' || element.reframeid === 'historical_one_off'; else notAvailable">
                          <span>Sample at Calibr</span>
                        </ng-container>
                        <ng-template #notAvailable>
                          <span>No sample at Calibr</span>
                        </ng-template>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <a [routerLink]="['/compound_data', element.id.split('/').pop(), {qid: element.qid.split('/').pop()}]">
                        <app-struct2d [structure]="element['svg']" [smiles]="element['smiles']" struct_type="svg" *ngIf="element['svg']; else no_glow"></app-struct2d>
                        <ng-template #no_glow>
                          <app-struct2d [structure]="element['smiles']" [smiles]="element['smiles']" struct_type="smiles" *ngIf="element['smiles']"></app-struct2d>
                        </ng-template>
                      </a>
                    </td>
                  </tr>
                </table>
              </mat-cell>
            </ng-container>

            <!-- Assay hits -->
            <ng-container matColumnDef="assays">
              <mat-header-cell *matHeaderCellDef mat-sort-header disableClear="true" class="mat-header" [matTooltip]="assayTooltip">
                <span class="mat-header">Assay Hits</span>
                <mat-icon class='sort-icon' matTooltip="sort by number of assay hits">sort</mat-icon>
              </mat-header-cell>
              <mat-cell *matCellDef="let element" [ngClass]="element['expanded'] ? 'expanded' : ''">
                <div class="d-flex justify-content-end flex-grow-1" *ngIf="element.assay_types.length > 0; else no_assays">
                  <ul class="assay-list d-flex flex-column">
                    <li class="assay-title" *ngFor="let assay of element.assay_types; let i=index">
                      <app-assay-indication [assay_name]="assay[0]" [assay_link]="assay[1]" [assay_type]="assay[2]"></app-assay-indication>
                    </li>
                  </ul>
                </div>
                <ng-template #no_assays></ng-template>
              </mat-cell>
            </ng-container>

            <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
            <mat-row *matRowDef="let row; columns: displayedColumns"></mat-row>
          </mat-table>

    <mat-paginator #paginator [pageSize]="pageSize" [pageIndex]="pageIdx" [pageSizeOptions]="[10, 25, 50, 100]" (page)="onPageChange($event)">
    </mat-paginator>
  </div>
</div>
